#! /usr/bin/env bash

cmd_dir=$(dirname "$0") || exit 1

panic()
{
	echo "ERROR: $@"
	exit 1
}

usage()
{
	if [ $# -gt 0 ]; then
		echo "BAD USAGE: $@"
	fi
	cat <<- EOF
	usage: $0 [options]

	Install the packages for the SDE.
	The -d option must be specified.

	Options:
	-h
	    Print help information and exit.
	-d \$install_dir
	    Set the installation directory to \$install_dir.
	EOF
	exit 2
}

sde_cmd="$cmd_dir/sde"

sde_top_dir=""

while getopts d:h opt; do
	case "$opt" in
	d)
		sde_top_dir="$OPTARG";;
	h)
		usage;;
	\?)
		usage;;
	esac
done
shift $((OPTIND - 1))

if [ -z "$sde_top_dir" ]; then
	usage "no top directory specified"
fi

# Set the user file-creation mask to allow read and execute permissions
# for the group and others.
# This will help to increase the likelihood that the installed software
# will be accessible by all users.
umask 022

if [ -n "$SDE_TEXLIVE_INSTALL" ]; then
	enable_texlive_install="$SDE_TEXLIVE_INSTALL"
else
	enable_texlive_install=1
fi

packages_dir="$sde_top_dir/packages"
boot_dir="$sde_top_dir/bootstrap"

cmake_version=3.9.4
gcc_version=7.2.0
clang_version=5.0.0
jasper_version=2.0.14
gdb_version=8.0.1
spl_version=2.0.6
ndiff_version=2.00
texlive_version=2017
boost_version=1.65.1
aristotle_version=2.23.0
ycm_version=31abb9cee59d5f74bbff14b6107e9c9316b6fc83
vim_version=8.0

gcc_install_options=()
if [ "${SDE_GCC_USE_OLD_ABI:-0}" -ne 0 ]; then
	gcc_install_options+=(-o old_abi)
else
	gcc_install_options+=(-o new_abi)
fi

install_cmake="$cmd_dir/install_cmake"
install_gcc="$cmd_dir/install_gcc"
install_clang="$cmd_dir/install_clang"
install_boost="$cmd_dir/install_boost"
install_texlive="$cmd_dir/install_texlive"
install_jasper="$cmd_dir/install_jasper"
install_gdb="$cmd_dir/install_gdb"
install_spl="$cmd_dir/install_spl"
install_ndiff="$cmd_dir/install_ndiff"
install_aristotle="$cmd_dir/install_aristotle"
install_ycm="$cmd_dir/install_ycm"
install_vim="$cmd_dir/install_vim"

cmake_dir="$packages_dir/cmake-$cmake_version"
gcc_dir="$packages_dir/gcc-$gcc_version"
gcc_bin_dir="$gcc_dir/bin"
clang_dir="$packages_dir/clang-$clang_version"
boost_dir="$packages_dir/boost-$boost_version"
texlive_dir="$packages_dir/texlive-$texlive_version"
jasper_dir="$packages_dir/jasper-$jasper_version"
gdb_dir="$packages_dir/gdb-$gdb_version"
spl_dir="$packages_dir/SPL-$spl_version"
ndiff_dir="$packages_dir/ndiff-$ndiff_version"
aristotle_dir="$packages_dir/aristotle-$aristotle_version"
ycm_dir="$packages_dir/ycm-$ycm_version"
#vim_dir="$packages_dir/vim-$vim_version"

# Since some software requires CMake to build, install CMake before
# building other software.

if [ -n "$cmake_dir" ]; then
	if [ ! -d "$cmake_dir" ]; then
		"$install_cmake" -v "$cmake_version" -d "$cmake_dir" || \
		  panic "cannot install cmake"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" cmake "$cmake_version" || \
	  panic "cannot configure cmake"

	if [ ! -d "$boot_dir" ]; then
		mkdir -p "$boot_dir" || panic "cannot make directory $boot_dir"
	fi
	target_file="$boot_dir/cmake"
	if [ -L "$target_file" -o -e "$target_file" ]; then
		rm -f "$target_file" || panic "cannot remove file $target_file"
	fi
	ln -s ../packages/cmake-$cmake_version/bin/cmake "$target_file" || \
	  panic "cannot make symbolic link for cmake"
fi

path="$boot_dir:$PATH"
export PATH="$path"

if [ -n "$gcc_dir" ]; then
	if [ ! -d "$gcc_dir" ]; then
		"$install_gcc" -v "$gcc_version" -d "$gcc_dir" \
		  "${gcc_install_options[@]}" || \
		  panic "cannot install gcc"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" gcc "$gcc_version" || \
	  panic "cannot configure gcc"
fi

if [ -n "$clang_dir" ]; then
	if [ ! -d "$clang_dir" ]; then

		# Try to compile Clang with Clang if it is available.
		#compiler_name="Clang"
		#cpp_compiler_command=$(type -P clang++) || cpp_compiler_command=""
		#c_compiler_command=$(type -P clang) || c_compiler_command=""

		# Try to build CLang with previously-installed version of GCC.
		#compiler_name="Previously-Installed GCC"
		#cpp_compiler_command=$(type -P g++) || cpp_compiler_command=""
		#c_compiler_command=$(type -P gcc) || c_compiler_command=""

		# Always build Clang with the SDE-installed version of GCC.
		cpp_compiler_command=""
		c_compiler_command=""

		if [ -z "$cpp_compiler_command" -o -z "$c_compiler_command" ]; then
			# Use SDE-installed version of GCC to build Clang.
			compiler_name="SDE-installed GCC"
			cpp_compiler_command="$gcc_dir/bin/g++"
			c_compiler_command="$gcc_dir/bin/gcc"
		fi
		echo "Building Clang with $compiler_name"
		CXX="$cpp_compiler_command" CC="$c_compiler_command" \
		"$install_clang" -l -v "$clang_version" -d "$clang_dir" -f || \
		  panic "cannot install clang"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" clang "$clang_version" || \
	  panic "cannot configure clang"
fi

if [ -n "$boost_dir" ]; then
	if [ ! -d "$boost_dir" ]; then
		"$install_boost" -v "$boost_version" -d "$boost_dir" || \
		  panic "cannot install boost"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" boost "$boost_version" || \
	  panic "cannot configure boost"
fi

if [ -n "$gdb_dir" ]; then
	if [ ! -d "$gdb_dir" ]; then
		"$install_gdb" -v "$gdb_version" -d "$gdb_dir" || \
		  panic "cannot install gdb"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" gdb "$gdb_version" || \
	  panic "cannot configure gdb"
fi

if [ "$enable_texlive_install" -ne 0 ]; then
	if [ ! -d "$texlive_dir" ]; then
		"$install_texlive" -v "$texlive_version" -d "$texlive_dir" || \
		  panic "cannot install texlive"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" texlive "$texlive_version" || \
	  panic "cannot configure texlive"
fi
texlive_bin_dir="$texlive_dir/bin"

# JasPer might need a more recent LaTeX version
# Install JasPer after LaTeX.
if [ -n "$jasper_dir" ]; then
	if [ ! -d "$jasper_dir" ]; then
		options=()
		if [ -d "$texlive_dir" ]; then
			options+=(-o build_doc)
			path_string="$texlive_bin_dir:"
		else
			options+=(-o no_build_doc)
			path_string=""
		fi
		PATH="${path_string}$PATH" \
		  "$install_jasper" -v "$jasper_version" -d "$jasper_dir" \
		  "${options[@]}" || \
		  panic "cannot install jasper"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" jasper "$jasper_version" || \
	  panic "cannot configure jasper"
fi

if [ -n "$spl_dir" ]; then
	if [ ! -d "$spl_dir" ]; then
		options=()
		if [ -d "$texlive_dir" ]; then
			options+=(-o build_doc)
			path_string="$texlive_bin_dir:"
		else
			options+=(-o no_build_doc)
			path_string=""
		fi
		PATH="$gcc_bin_dir:${path_string}$PATH" \
		  "$install_spl" -v "$spl_version" -d "$spl_dir" "${options[@]}" || \
		  panic "cannot install SPL"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" SPL "$spl_version" || \
	  panic "cannot configure SPL"
fi

if [ -n "$ndiff_dir" ]; then
	if [ ! -d "$ndiff_dir" ]; then
		"$install_ndiff" -v "$ndiff_version" -d "$ndiff_dir" || \
		  panic "cannot install ndiff"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" ndiff "$ndiff_version" || \
	  panic "cannot configure ndiff"
fi

if [ -n "$aristotle_dir" ]; then
	if [ ! -d "$aristotle_dir" ]; then
		"$install_aristotle" -v "$aristotle_version" -d "$aristotle_dir" || \
		  panic "cannot install aristotle"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" aristotle "$aristotle_version" || \
	  panic "cannot configure aristotle"
fi

if [ -n "$vim_dir" ]; then
	if [ ! -d "$vim_dir" ]; then
		"$install_vim" -v "$vim_version" -d "$vim_dir" || \
		  panic "cannot install vim"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" vim "$vim_version" || \
	  panic "cannot configure vim"
fi

if [ -n "$ycm_dir" ]; then
	if [ ! -d "$ycm_dir" ]; then
		libclang="$clang_dir/lib/libclang.so"
		#PATH="$clang_dir/bin:$PATH" \
		CXX="$clang_dir/bin/clang++" \
		  CC="$clang_dir/bin/clang" \
		  "$install_ycm" -v "$ycm_version" -d "$ycm_dir" -l "$libclang" -V || \
		  panic "cannot install ycm"
	fi
	"$sde_cmd" pkg -d "$sde_top_dir" ycm "$ycm_version" || \
	  panic "cannot configure ycm"
fi
