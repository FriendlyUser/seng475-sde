#! /bin/bash

panic()
{
	echo "FATAL ERROR: $@" 1>&2
	exit 1
}

usage()
{
	echo "BAD USAGE: $@" 1>&2
	exit 2
}

eprint()
{
	echo "$@" 1>&2
}

cmd_dir=`dirname $0` || panic "cannot get command directory"

sde_top_dir=""
while getopts d: opt; do
	case "$opt" in
	d)
		sde_top_dir="$OPTARG";;
	\?)
		usage
		break;;
	esac
done
shift $((OPTIND - 1))

if [ -z "$sde_top_dir" ]; then
	usage "no top directory specified"
fi

if [ ! -d "$sde_top_dir" ]; then
	panic "invalid top directory specified $sde_top_dir"
fi

for dir in bin etc environments; do
	if [ ! -d "$sde_top_dir/$dir" ]; then
		mkdir -p "$sde_top_dir/$dir" || \
		  panic "cannot make directory $dir"
	fi
done

# non-executables in $sde_top_dir directory
for file in README; do
	echo "installing $file in $sde_top_dir"
	install -m a+r $cmd_dir/$file $sde_top_dir/$file || \
	  panic "cannot install $file"
done

# non-executables in $sde_top_dir/etc directory
for file in motd; do
	echo "installing $file in $sde_top_dir/etc"
	install -m a+r "$cmd_dir/$file" "$sde_top_dir/etc" || \
	  panic "cannot install $file"
done

# executables in $sde_top_dir/bin directory
for file in sde_shell sde_make_setup wrapper; do
	echo "installing $file in $sde_top_dir/bin"
	install -m a+rx $cmd_dir/$file $sde_top_dir/bin || \
	  panic "cannot install $file"
done

for file in g++ gcc clang++ clang cmake ctest cpack; do
	target_file="$sde_top_dir/bin/$file"
	if [ -e "$target_file" ]; then
		rm -f "$target_file"
	fi
	ln -s wrapper "$target_file" || \
	  panic "cannot link"
done

# non-executables in $sde_top_dir/bin directory
for file in sde_shell_bashrc; do
	echo "installing $file in $sde_top_dir/bin"
	install -m a+r $cmd_dir/$file $sde_top_dir/bin || \
	  panic "cannot install $file"
done

for file in default spl; do
	install -m a+r \
	  "$cmd_dir/../examples/$file" "$sde_top_dir/environments" || \
	  panic "cannot install $file"
done

# executables in $sde_top_dir/root/usr/bin directory
#for file in gcc g++ gdb; do
#	echo "installing $file in $sde_top_dir/root/usr/bin"
#	install -m a+rx $cmd_dir/$file $sde_top_dir/root/usr/bin || \
#	  panic "cannot install $file"
#done

if [ 1 -ne 0 ]; then
	echo "giving world access to $sde_top_dir"
	"$cmd_dir/give_world_access" "$sde_top_dir" || panic "failed"
fi

