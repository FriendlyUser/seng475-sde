#! /usr/bin/env bash

# __START_OF_LICENSE__
# 
# Copyright (c) 2017, 2018 Michael D. Adams
# All rights reserved.
# 
# This file is part of the SDE software.
# 
# This program is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation; either version 3,
# or (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public
# License along with this program; see the file LICENSE.  If not,
# see <http://www.gnu.org/licenses/>.
# 
# __END_OF_LICENSE__

panic()
{
	echo "FATAL ERROR: $@" 1>&2
	exit 1
}

eecho()
{
	echo "$@" 1>&2
}

function join_by
{
	local IFS="$1"
	shift
	echo "$*"
}

preprocess_env_file()
{
	sed -e 's/#.*$//' -e '/^$/d'
}

add_to_path()
{
	if [ $# -ne 3 ]; then
		return 1
	fi
	local path="$1"
	local prefix="$2"
	local suffix="$3"
	if [ -n "$prefix" ]; then
		if [ -n "$path" ]; then
			path="$prefix:$path"
		else
			path="$prefix"
		fi
	fi
	if [ -n "$suffix" ]; then
		if [ -n "$path" ]; then
			path="$path:$suffix"
		else
			path="$suffix"
		fi
	fi
	echo "$path"
}

bash_setup()
{
	echo 'export SDE_LEVEL="'$sde_level'";' || return 1

	echo 'export SDE_NAME='"$sde_name"';' || return 1
	echo 'export SDE_TOP_DIR='"$sde_top_dir"';' || return 1

#	local path=$(add_to_path \
#	  "$PATH" $(join_by : "${path_prefix[@]}") \
#	  $(join_by : "${path_suffix[@]}")) || \
#	  return 1
	if [ "$emit_path" -ne 0 ]; then
		local path=("${path_prefix[@]}" $PATH "${path_suffix[@]}")
		echo 'export PATH='\"$(join_by : ${path[@]})\"';' || \
		  return 1
		echo 'export SDE_OLD_PATH="'$old_path'";' || return 1
	fi
	echo 'export SDE_PATH_PREFIX='\"$(join_by : ${path_prefix[@]})\"';' || \
	  return 1
	echo 'export SDE_PATH_SUFFIX='\"$(join_by : ${path_suffix[@]})\"';' || \
	  return 1

	# GNU C++ compiler
	echo 'export SDE_GCC_CXX_PROGRAM='"$gcc_cxx_program"';' || \
	  return 1
	echo 'export SDE_GCC_CXX_TRANSFORM='\""$gcc_cxx_transform"\"';' || \
	  return 1
	if [ ${gcc_cxx_transform:-0} -ne 0 ]; then
		echo 'export SDE_GCC_CXX_OPTIONS_PREFIX='\""${gcc_cxx_options_prefix[*]}"\"';' || \
		  return 1
		echo 'export SDE_GCC_CXX_OPTIONS_SUFFIX='\""${gcc_cxx_options_suffix[*]}"\"';' || \
		  return 1
	fi

	# GNU C compiler
	echo 'export SDE_GCC_C_PROGRAM='"$gcc_c_program"';' || \
	  return 1
	echo 'export SDE_GCC_C_TRANSFORM='\""$gcc_c_transform"\"';' || \
	  return 1
	if [ ${gcc_c_transform:-0} -ne 0 ]; then
		echo 'export SDE_GCC_C_OPTIONS_PREFIX='\""${gcc_c_options_prefix[*]}"\"';' || \
		  return 1
		echo 'export SDE_GCC_C_OPTIONS_SUFFIX='\""${gcc_c_options_suffix[*]}"\"';' || \
		  return 1
	fi

	# Clang C++ compiler
	echo 'export SDE_CLANG_CXX_PROGRAM='"$clang_cxx_program"';' || \
	  return 1
	echo 'export SDE_CLANG_CXX_TRANSFORM='\""$clang_cxx_transform"\"';' || \
	  return 1
	if [ ${clang_cxx_transform:-0} -ne 0 ]; then
		echo 'export SDE_CLANG_CXX_OPTIONS_PREFIX='\""${clang_cxx_options_prefix[*]}"\"';' || \
		  return 1
		echo 'export SDE_CLANG_CXX_OPTIONS_SUFFIX='\""${clang_cxx_options_suffix[*]}"\"';' || \
		  return 1
	fi

	# Clang C compiler
	echo 'export SDE_CLANG_C_PROGRAM='"$clang_c_program"';' || \
	  return 1
	echo 'export SDE_CLANG_C_TRANSFORM='\""$clang_c_transform"\"';' || \
	  return 1
	if [ ${sde_clang_c_transform:-0} -ne 0 ]; then
		echo 'export SDE_CLANG_C_OPTIONS_PREFIX='\""${clang_c_options_prefix[*]}"\"';' || \
		  return 1
		echo 'export SDE_CLANG_C_OPTIONS_SUFFIX='\""${clang_c_options_suffix[*]}"\"';' || \
		  return 1
	fi

	# CMake
	echo 'export SDE_CMAKE_PROGRAM='"$cmake_program"';' || \
	  return 1
	echo 'export SDE_CMAKE_TRANSFORM='"$cmake_transform"';' || \
	  return 1
	if [ ${cmake_transform:-0} -ne 0 ]; then
#		#  return 1
#		local path=$(add_to_path \
#		  "$CMAKE_PREFIX_PATH" \
#		  $(join_by : "${cmake_path_prefix[@]}") \
#		  $(join_by : "${cmake_path_suffix[@]}")) || \
#		  return 1
#		echo 'export CMAKE_PREFIX_PATH='\"$path\"';' || \
#		  return 1
		echo 'export SDE_CMAKE_PATH_PREFIX='\"$(join_by : ${cmake_path_prefix[@]})\"';' || \
		  return 1
		echo 'export SDE_CMAKE_PATH_SUFFIX='\"$(join_by : ${cmake_path_suffix[@]})\"';' || \
		  return 1
	fi

	# CXX and CC environment variables
	#echo 'export SDE_CXX='"$SDE_GCC_CXX_PROGRAM"';' || \
	#  return 1
	#echo 'export SDE_CC='"$SDE_GCC_CC_PROGRAM"';' || \
	#  return 1

	echo 'export SDE_GDB_PROGRAM='"$gdb_program"';' || \
	  return 1

	local path=$(add_to_path \
	  "$LD_LIBRARY_PATH" $(join_by : "${ld_library_path_prefix[@]}") \
	  $(join_by : "${ld_library_path_suffix[@]}")) || \
	  return 1
	echo 'export LD_LIBRARY_PATH='\"$path\"';' || \
	  return 1

	if [ -n "$boost_root" ]; then
		echo 'export BOOST_ROOT='\"$boost_root\"';' || \
		  return 1
	fi
}

usage()
{
	echo "$@"
	cat <<- EOF
	usage: $0 [options]
	options:
	-n env
	    Set the environment to env.
	-s shell
	    Set the shell to shell.
	-v
	    Increase the verbosity level of output.
	-f
	    Allow use of command from within SDE environment.
	EOF
	exit 2
}

cmd_dir=$(dirname "$0") || panic "cannot get command directory"
top_dir="$cmd_dir/.."
default_env_file="$top_dir/etc/default_environment"
env_dir="$top_dir/etc/environments"

all_packages_name="__all__"

debug_level="${SDE_DEBUG_LEVEL:-0}"
verbose=0
shell=bash
name=
force=0
package_spec=

gcc_cxx_transform=0
gcc_c_transform=0
clang_cxx_transform=0
clang_c_transform=0
cmake_transform=0
adaptive=0
emit_path=0
boost_root=

while getopts vn:s:fap:ZD: opt; do
	case "$opt" in
	D)
		debug_level="$OPTARG";;
	a)
		adaptive=1;;
	n)
		name="$OPTARG";;
	s)
		shell="$OPTARG";;
	f)
		force=1;;
	v)
		verbose=1;;
	p)
		package_spec="$OPTARG";;
	Z)
		emit_path=1;;
	*)
		usage "invalid option $opt";;
	esac
done
shift $((OPTIND - 1))

if [ "$debug_level" -ge 10 ]; then
	set -xv
fi

if [ "$debug_level" -ge 1 ]; then
	eecho "name $name [${#name}]"
	eecho "package_spec $package_spec [${#package_spec}]"
	eecho "adaptive $adaptive"
	eecho "emit_path $emit_path"
fi

if [ $# -ne 0 ]; then
	usage "unexpected arguments $@"
fi

if [ "$name" = "$all_packages_name" ]; then
	name=
	adaptive=1
fi

if [ -z "$SDE_LEVEL" ]; then
	sde_level=0
	#old_path="$PATH"
else
	sde_level="$SDE_LEVEL"
	#old_path="$SDE_OLD_PATH"
fi
sde_level=$((sde_level + 1))

#if [ "$sde_level" -ge 2 ]; then
#	PATH="$old_path"
#fi

if [ -n "$SDE_NAME" -a "$force" -eq 0 ]; then
	panic "invoking from within SDE environment disallowed"
fi

if [ -z "$name" -a -z "$package_spec" -a "$adaptive" -eq 0 ]; then
	if [ ! -f "$default_env_file" ]; then
		panic "no default environment available"
	fi
	name=$(cat "$default_env_file") || panic
fi

case "$SHELL" in
*bash*)
	shell=bash;;
*tcsh*)
	shell=tcsh;;
esac

cmd_dir=$(dirname "$0") || panic "cannot get directory name"
abs_cmd_dir=$(readlink -f "$cmd_dir") || \
  panic "cannot get canonical directory name"

sde_top_dir="$abs_cmd_dir/.."
sde_top_dir=$(readlink -f "$sde_top_dir") || panic "readlink failed"

packages_dir="$sde_top_dir/packages"

packages_valid=0

if [ "$packages_valid" -eq 0 -a "$adaptive" -ne 0 ]; then
	packages=()
	for path in "$packages_dir"/*; do
		package_name=$(basename "$path") || panic
		if [ -d "$path" ]; then
			if [[ "$package_name" =~ ^[^-]*$ ]]; then
				packages+=("$package_name")
			fi
		fi
	done
	packages_valid=1
	name="$all_packages_name"
fi

if [ "$packages_valid" -eq 0 -a -n "$name" ]; then
	packages=($(preprocess_env_file < "$env_dir/$name")) || panic
	packages_valid=1
fi

if [ "$packages_valid" -eq 0 -a -n "$package_spec" ]; then
		packages=($(echo "$package_spec" | tr ':' ' ')) || panic
		if [ -z "$name" ]; then
			name="explicit"
		fi
		packages_valid=1
fi

sde_name="$name"

has_cmake_package=0
has_gcc_package=0
has_clang_package=0
has_gdb_package=0
use_libcxx=0
has_normal_package=0

path_prefix=()
path_suffix=()
inc_path=()
lib_path=()
cmake_path_prefix=()
cmake_path_suffix=()

clang_dir="$packages_dir/clang"
gcc_dir="$packages_dir/gcc"

# This directory must be first in the search path.
path_prefix+=("$sde_top_dir/bin")

for package in "${packages[@]}"; do
	if [ ! -d "$packages_dir/$package" ]; then
		if [ "$verbose" -ge 1 ]; then
			eecho "ignoring nonexistent package $package"
		fi
		continue
	fi
	target="$packages_dir/$package/bin"
	if [ -d "$target" ]; then
		path_prefix+=("$target")
	fi
	case "$package" in
	gcc|gcc-*)
		has_gcc_package=1;;
	clang|clang-*)
		has_clang_package=1;;
	cmake|cmake-*)
		has_cmake_package=1;;
	gdb|gdb-*)
		has_gdb_package=1;;
	libcxx|libcxx-*)
		use_libcxx=1;;
	boost|boost-*)
		boost_root="$packages_dir/$package";;
	esac
	case "$package" in
	gcc|gcc-*|clang|clang-*)
		;;
	*)
		has_normal_package=1;;
	esac
	case "$package" in
	gcc|gcc-*|clang|clang-*|gdb|gdb-*|sdebase|sdebase-*)
		;;
	*)
		target="$packages_dir/$package/include"
		if [ -d "$target" ]; then
			inc_path+=("$target")
		fi
		target="$packages_dir/$package/lib"
		if [ -d "$target" ]; then
			lib_path+=("$target")
		fi
		target="$packages_dir/$package/lib64"
		if [ -d "$target" ]; then
			lib_path+=("$target")
		fi
		target="$packages_dir/$package"
		if [ -d "$target/include" ]; then
			cmake_path_prefix+=("$target")
		fi
		;;
	esac
done

if [ "$has_normal_package" -ne 0 ]; then
	cmake_transform=1
fi

if [ "$use_libcxx" -ne 0 ]; then
	clang_cxx_options_prefix+=(-stdlib=libc++ -isystem \
	  "$clang_dir"/include/c++/v1)
	clang_cxx_options_suffix+=(-L"$gcc_dir"/lib64 -Wl,-rpath,"$gcc_dir"/lib64)
	clang_cxx_options_suffix+=(-L"$clang_dir"/lib -Wl,-rpath,"$clang_dir"/lib)
else
	clang_cxx_options_prefix+=(--gcc-toolchain="$gcc_dir")
	clang_cxx_options_suffix+=(-L"$gcc_dir"/lib64 -Wl,-rpath,"$gcc_dir"/lib64)
	clang_cxx_options_suffix+=(-L"$clang_dir"/lib -Wl,-rpath,"$clang_dir"/lib)
fi

for dir in "${inc_path[@]}"; do
	gcc_cxx_options_prefix+=(-isystem "$dir")
	clang_cxx_options_prefix+=(-isystem "$dir")
	gcc_c_options_prefix+=(-isystem "$dir")
	clang_c_options_prefix+=(-isystem "$dir")
done
for dir in "${lib_path[@]}"; do
	gcc_cxx_options_suffix+=(-L "$dir")
	clang_cxx_options_suffix+=(-L "$dir")
	gcc_c_options_suffix+=(-L "$dir")
	clang_c_options_suffix+=(-L "$dir")
done

if [ "$has_gcc_package" -ne 0 ]; then
	gcc_cxx_program="$packages_dir/gcc/bin/g++"
	gcc_c_program="$packages_dir/gcc/bin/gcc"
	ld_library_path_prefix+=($packages_dir/gcc/lib)
	gcc_cxx_options_suffix+=(-Wl,-rpath,"$packages_dir/gcc/lib64")
	gcc_c_options_suffix+=(-Wl,-rpath,"$packages_dir/gcc/lib64")
	gcc_c_transform=1
	gcc_cxx_transform=1
else
	gcc_cxx_program=$(type -p g++) || gcc_cxx_program=false
	gcc_c_program=$(type -p gcc) || gcc_c_program=false
fi
if [ "$has_clang_package" -ne 0 ]; then
	clang_cxx_program="$packages_dir/clang/bin/clang++"
	clang_c_program="$packages_dir/clang/bin/clang"
	clang_cxx_options_suffix+=(-Wl,-rpath,"$packages_dir/clang/lib64")
	clang_c_options_suffix+=(-Wl,-rpath,"$packages_dir/clang/lib64")
	clang_cxx_transform=1
	clang_c_transform=1
else
	clang_cxx_program=$(type -p clang++) || clang_cxx_program=false
	clang_c_program=$(type -p clang) || clang_c_program=false
fi
if [ "$has_cmake_package" -ne 0 ]; then
	cmake_program="$packages_dir/cmake/bin/cmake"
else
	cmake_program=$(type -p cmake) || cmake_program=false
fi
if [ "$has_gdb_package" -ne 0 ]; then
	gdb_program="$packages_dir/gdb/bin/gdb"
else
	gdb_program=$(type -p gdb) || gdb_program=false
fi

if [ "$verbose" -ge 1 ]; then
	eecho "packages:"
	for package in "${packages[@]}"; do
		eecho "    $package"
	done
	eecho "include directories:"
	for dir in "${inc_path[@]}"; do
		eecho "    $dir"
	done
	eecho "library directories:"
	for dir in "${lib_path[@]}"; do
		eecho "    $dir"
	done
	eecho "cmake directories:"
	for dir in "${cmake_path_prefix[@]}"; do
		eecho "    $dir"
	done
	for dir in "${cmake_path_suffix[@]}"; do
		eecho "    $dir"
	done
fi

if [ "$verbose" -ge 1 ]; then
	eecho "name $name"
	eecho "shell $shell"
	eecho "level $sde_level"
fi

case "$shell" in
bash)
	bash_setup;;
*)
	panic "Unsupported shell $shell";;
esac

exit

