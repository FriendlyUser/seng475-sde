#! /bin/bash

# Reference: https://cmake.org/download/

panic()
{
	echo "ERROR: $@"
	exit 1
}

warn()
{
	echo "WARNING: $@"
}

usage()
{
	echo "BAD USAGE: $@"
	echo "usage: $0 -v version -p install_dir"
	exit 2
}

user=$(whoami) || panic "cannot get user name"
host=$(hostname) || panic "cannot get host name"
cur_dir=$(pwd) || panic "cannot get current directory"

#version=3.6.3
version=3.7.1
install_dir="$cur_dir/cmake-$version"
tmp_dir="/tmp/install_cmake-$user@$host-$$"

while getopts d:v: opt; do
	case "$opt" in
	d)
		install_dir="$OPTARG";;
	v)
		version="$OPTARG";;
	\?)
		usage
		break;;
	esac
done
shift $((OPTIND - 1))

if [ -z "$install_dir" ]; then
	usage "no installation directory specified"
fi
if [ -z "$version" ]; then
	usage "no version specified"
fi

short_version=$(echo "$version" | sed -e 's/\.[0-9]*$//') || \
  panic "cannot extract short version"
url="https://cmake.org/files/v$short_version/cmake-$version-Linux-x86_64.tar.gz"
archive=$(basename $url) || panic "cannot extract archive name"

if [ -d "$install_dir" ]; then
	panic "installation directory already exists"
fi

mkdir -p "$tmp_dir" || \
  panic "cannot make temporary directory $tmp_dir"

(cd "$tmp_dir" && wget "$url") || \
  panic "cannot download archive"

mkdir -p "$install_dir" || \
  panic "cannot make directory $install_dir"

tar -x -z --strip-components=1 -C "$install_dir" -f "$tmp_dir/$archive" || \
  panic "cannot extract archive"

for file in ccmake cmake cmake-gui cpack ctest; do
	target_file="$install_dir/bin/$file"
	chmod a+rx "$target_file" || \
	  panic "cannot set permission for $target_file"
done

rm -f "$tmp_dir/$archive"
rmdir "$tmp_dir" || warn "cannot remove temporary directory $tmp_dir"

exit 0
